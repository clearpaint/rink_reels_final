<!-- Parent html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rink Reels</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Local Font Awesome CSS -->
  <link rel="stylesheet" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="@sweetalert2/themes/dark/dark.css" />

  <!-- Optional OpenCV -->
  <script src="https://docs.opencv.org/4.8.0/opencv.js" type="text/javascript"></script>

</head>
<body>

<nav class="navbar navbar-dark bg-dark navbar-expand-md fixed-top">
  <div class="container-fluid p-0">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#topNavbar" aria-controls="topNavbar"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsed content -->
    <div class="collapse navbar-collapse" id="topNavbar">
      <ul class="navbar-nav">

        <!-- Video Panel -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="video-panel"
                  onclick="toggleSidebar('videoPanel')"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Open/Close Video Panel">
            <i class="fas fa-folder-closed"></i>
          </button>
        </li>

        <li class="nav-item"><hr class="dropdown-divider bg-secondary" /></li>

        <!-- Zoom Out -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="mag-minus"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Zoom Out">
            <i class="fas fa-magnifying-glass-minus"></i>
          </button>
        </li>

        <!-- Zoom In -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="mag-plus"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Zoom In">
            <i class="fas fa-magnifying-glass-plus"></i>
          </button>
        </li>

        <!-- Reset View -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="reset-view"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Reset View">
            <i class="fas fa-home"></i>
          </button>
        </li>

        <li class="nav-item"><hr class="dropdown-divider bg-secondary" /></li>

        <!-- Pointer Tool -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="mouse-pointer"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Pointer Tool">
            <i class="fas fa-mouse-pointer"></i>
          </button>
        </li>

        <!-- Pen Tool -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="pen"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Pen Tool (Free Draw)">
            <i class="fas fa-pen"></i>
          </button>
        </li>

        <!-- Vector Square -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="vector-square"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Draw Rectangle">
            <i class="fas fa-vector-square"></i>
          </button>
        </li>

        <!-- Project Diagram -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="project-diagram"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Connection Lines">
            <i class="fas fa-project-diagram"></i>
          </button>
        </li>

        <!-- Draw Polygon -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="draw-polygon"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Draw Polygon">
            <i class="fas fa-draw-polygon"></i>
          </button>
        </li>

        <!-- Comment -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="comment"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Add Comment">
            <i class="fas fa-comment"></i>
          </button>
        </li>

        <!-- Circle Notch -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="circle-notch"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Draw Circle">
            <i class="fas fa-circle-notch"></i>
          </button>
        </li>

        <!-- Set Homography -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="set-homography"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Set Homography">
            <i class="fas fa-ring"></i>
          </button>
        </li>

        <!-- Eraser -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="eraser"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Clear Canvas">
            <i class="fa fa-eraser"></i>
          </button>
        </li>

        <!-- Undo -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="undo"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Undo Last">
            <i class="fas fa-undo"></i>
          </button>
        </li>

        <!-- Capture Frame -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="camera"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Capture Frame">
            <i class="fas fa-camera"></i>
          </button>
        </li>

        <li class="nav-item"><hr class="dropdown-divider bg-secondary" /></li>
        <li class="nav-item">
          <button id="openSegModal" class="nav-link"
                  data-btn-id="player-tracking"
                  onclick="openSegmentationModal()"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Track Players">
            <i class="fas fa-running"></i>
          </button>
        </li>
        <!-- Player Tracking
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="player-tracking"
                  onclick="displaySegPanel()"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Track Players">
            <i class="fas fa-running"></i>
          </button>
        </li>-->
        <li class="nav-item">
          <button class="nav-link"
                  id="returnToVideoBtn"
                  style="display:none;"
                  onclick="returnToVideoView()"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Return to Video Viewer">
            <i class="fas fa-arrow-left"></i>
          </button>
        </li>

        <!-- Audio Detection -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="audio-detect"
                  onclick="detectAudioEvents()"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Detect Audio Events">
            <i class="fas fa-ear-listen"></i>
          </button>
        </li>

        <!-- Tag Panel -->
        <li class="nav-item">
          <button class="nav-link"
                  data-btn-id="tag"
                  onclick="toggleSidebar('tagPanel')"
                  data-bs-toggle="tooltip"
                  data-bs-trigger="hover"
                  data-bs-placement="bottom"
                  title="Open/Close Tag Panel">
            <i class="fas fa-tags"></i>
          </button>
        </li>
                <!-- Concat Panel -->
        <li class="nav-item">
          <button
            id="openChildModal"
            class="nav-link"
            data-btn-id="tag"
            data-bs-toggle="tooltip"
            data-bs-trigger="hover"
            data-bs-placement="bottom"
            title="Open/Close Concat Panel"
          >
            <i class="fas fa-film"></i>
          </button>
        </li>


        <!-- Export Spinner (not a button, so no tooltip) -->
        <li class="nav-item d-flex align-items-center ms-2">
            <i id="exportSpinner"
               class="fas fa-spinner fa-spin"
               style="display: none;
                      position: fixed;
                      top: 1rem;
                      right: 2rem;
                      z-index: 9999;
                      font-size: 1.75rem;
                      color: white;">
            </i>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div id="childModal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <iframe id="childFrame" style="width:100%; height:80vh; border:none;"></iframe>
  </div>
</div>

<!-- Segmentation Modal -->
<div id="segmentationModal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-modal-seg">&times;</span>
    <iframe id="segmentationFrame"
            src=""
            style="width:100%; height:80vh; border:none;">
    </iframe>
  </div>
</div>

<!-- Bottom Panel (new addition)
<div id="segmentationPanel" class="bottom-panel collapsed">
  <div id="resizeHandle"></div> New resize handle
  <div class="bottom-panel-header" onclick="toggleBottomPanel()" data-bs-toggle="tooltip" data-bs-placement="top" title="Click to Expand/Collapse">
    <div class="d-flex justify-content-between align-items-center px-3 py-2">
      <span><i class="fas fa-running"></i> Player Tracking</span>
      <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="reloadSegmentationContent(event)">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button id="maximizeButton" class="btn btn-sm btn-outline-light" onclick="toggleMaximizePanel(event)">
          <i id="maximizeIcon" class="fas fa-expand-alt"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="bottom-panel-content" style="overflow: hidden;">
    <div id="segmentationContent" class="p-3" style="height: 100%;">
      <iframe
        id="segmentationFrame"
        src="index_2.html"
        style="border: none; width: 100%; height: 100%; display: block;">
      </iframe>
    </div>
  </div>
</div>
-->

  <!-- Left Sidebar -->
<div id="videoPanel" class="sidebar left collapsed">
  <h5 class="text-center">Video Items</h5>
  <button id="toggleVideoFormBtn" class="btn btn-outline-light w-100 mb-2" onclick="toggleVideoForm()">
    <i class="fa-solid fa-plus"></i>
  </button>

  <div id="addVideoForm" style="display: none;">

    <!-- Hidden file input (so the browser never shows "No file chosen") -->
    <input
      type="file"
      id="videoInput"
      class="visually-hidden"
      accept="video/*"
    />

    <!-- A custom button that triggers Electron's native dialog -->
    <button
      id="chooseFileBtn"
      class="btn btn-secondary w-100"
      onclick="onFileInputClick(event)"
    >
      Choose File
    </button>

    <!-- Our custom label that will show the selected path -->
    <div
      id="selectedFileLabel"
      style="color: #ccc; font-size: 0.85rem; margin-top: 4px;"
    >
      No file chosen
    </div>

    <input
      type="text"
      id="videoName"
      class="form-control mt-2"
      placeholder="Enter video name"
    />

    <button
      class="btn btn-primary w-100 mt-2"
      onclick="addVideo()"
    >
      Add Video
    </button>
  </div>

  <div id="videoList" class="mt-3"></div>
</div>

  <!-- Right Sidebar -->
  <div id="tagPanel" class="sidebar right collapsed" style="right: 0;">
    <h5 class="text-center">Video Tags</h5>
    <select id="presetTags" class="form-control mb-2">
      <option value="">Select a preset tag</option>
      <option value="Goal">Goal</option>
      <option value="Shot">Shot</option>
      <option value="Block">Block</option>
      <option value="Face-Off">Face-Off</option>
    </select>
    <div class="input-group mb-2">
      <input type="text" id="tagInput" class="form-control" placeholder="Enter tag" />
      <button class="btn btn-primary" onclick="addTag()">Add Tag</button>
    </div>
    <button class="btn btn-outline-light w-100 mb-3" onclick="detectAudioEvents()">
      <i class="fa-solid fa-waveform-lines"></i> Detect Audio
    </button>
    <div id="tagList" class="mt-3 flex-grow-1"></div>
    <button class="btn btn-outline-light w-100 mt-3" onclick="exportTags()">
      <i class="fa-solid fa-file-export"></i> Export
    </button>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div id="videoWrapper">
      <h5 id="videoTitle"></h5>
      <!-- Responsive VIDEO CONTAINER -->
      <div class="video-container">
        <video id="videoPlayer" preload="auto"></video>
        <!-- Canvas for drawings (freehand, shapes, homography overlays, etc.) -->
        <canvas id="drawCanvas" willReadFrequently="true"></canvas>
        <!-- Bottom controls: player bar & timeline -->
        <div class="bottom-controls">
          <div class="player-bar">
            <div class="time" id="playerBarTime">00:00:00</div>
            <div class="progress-container" id="playerBarProgressContainer">
              <div class="progress" id="playerBarProgress">
                <div class="progress-fill" id="playerBarProgressFill"></div>
                <div class="progress-dot" id="playerBarProgressDot"></div>
              </div>
            </div>
            <div class="controls" id="playerBarControls">
              <i class="fas fa-play" id="playerPlayPause"></i>
              <i class="fas fa-step-backward" id="playerStepBack"></i>
              <i class="fas fa-backward" id="playerBackward"></i>
              <i class="fas fa-volume-mute" id="playerMute"></i>
              <span id="playerSpeed">x1</span>
              <i class="fas fa-step-forward" id="playerStepForward"></i>
            </div>
            <div class="actions">
              <div class="label" id="action-upload"></div>
            </div>
          </div>
          <div class="timeline-container" id="timelineContainer">
            <div class="selection" id="selection"></div>
            <div class="handle" id="handleStart"></div>
            <div class="handle" id="handleEnd"></div>
            <div id="timelineTags"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for upload -->
  <input type="file" id="videoUploaderFirst" accept="video/*,image/*" style="display: none;" />
  <!-- Toast Container -->
  <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Homography Context Menu (for editing halo overlay colors) -->
  <div id="homographyContextMenu">
    <div>
      <label for="homographyDropdownRingColor">Ring Color:</label>
      <input type="color" id="homographyDropdownRingColor" value="#ffffff">
    </div>
    <div>
      <label for="homographyDropdownSpotlightColor">Spotlight Color:</label>
      <input type="color" id="homographyDropdownSpotlightColor" value="#ffffff">
    </div>
    <button id="homographyDropdownSaveBtn">Save</button>
  </div>
  <!-- SAM2 Segmentation Settings -->
<!-- SAM2 Segmentation Settings -->
<div id="segmentationPanelold" class="sidebar collapsed" style="right:0;">
  <h5 class="text-center">Segmentation Settings</h5>
  <div class="p-3">
    <label>Checkpoint:<br>
      <input id="seg_checkpoint" class="form-control" type="text"
             value="/path/to/sam2.pt" />
    </label>
    <label class="mt-2">Config:<br>
      <input id="seg_config" class="form-control" type="text"
             value="configs/sam2.yaml" />
    </label>
    <label class="mt-2">FPS:<br>
      <input id="seg_fps" class="form-control" type="number" value="30" />
    </label>
    <button class="btn btn-outline-light w-100 mb-2" onclick="enableSAM2ClickMode()">
      Click Mode
    </button>
    <button class="btn btn-outline-light w-100 mb-2" onclick="enableSAM2BoxMode()">
      Box Mode
    </button>
    <button class="btn btn-primary w-100" onclick="startSAM2Propagation()">
      Start Tracking
    </button>
    <button class="btn btn-secondary w-100 mt-3"
            onclick="toggleSidebar('segmentationPanel')">Close</button>
  </div>
</div>
  <!-- Bootstrap Bundle (with Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>

<script>
  console.log("[PARENT] parent.html loaded.");

  // Modal state
  let modalVisible = false;
  const modal  = document.getElementById('childModal');
  const iframe = document.getElementById('childFrame');

  // ─── Open modal ─────────────────────────────────────────
  document.getElementById('openChildModal').onclick = () => {
    modal.style.display = 'flex';
    modalVisible = true;
    document.body.style.overflow = 'hidden';
    if (!iframe.src) {
      iframe.src = 'child2.html';
    }
  };

  // ─── Close modal ────────────────────────────────────────
  function doClose() {
    modal.style.display = 'none';
    modalVisible = false;
    document.body.style.overflow = 'auto';
  }
  document.querySelector('.close-modal').onclick = doClose;
  modal.onclick = e => {
    if (e.target === e.currentTarget) doClose();
  };

  // ─── Segmentation Modal Logic ───────────────────────────
document.getElementById('openSegModal').onclick = openSegmentationModal;

let segModalVisible = false;
const segModal  = document.getElementById('segmentationModal');
const segFrame  = document.getElementById('segmentationFrame');
let   segState  = {};

function openSegmentationModal() {
  segModal.style.display = 'flex';
  segModalVisible = true;
  document.body.style.overflow = 'hidden';

  // first open: actually load the iframe URL; subsequent opens: restore state
  if (!segFrame.getAttribute('src')) {
    segFrame.setAttribute('src', 'index_2.html');
  } else {
    segFrame.contentWindow.postMessage(
      { action: 'LOAD_SEG_STATE', state: segState },
      '*'
    );
  }
}


function closeSegmentationModal() {
  segModal.style.display = 'none';
  segModalVisible = false;
  document.body.style.overflow = 'auto';
  segFrame.contentWindow.postMessage(
    { action: 'SAVE_AND_CLOSE' },
    '*'
  );
}

document.querySelector('.close-modal-seg').onclick = closeSegmentationModal;
segModal.onclick = (e) => {
  if (e.target === segModal) closeSegmentationModal();
};

  // ─── Listen for messages from child iframes ────────────
window.addEventListener('message', async (event) => {
  const msg    = event.data || {};
  const action = msg.action;

  // ─── Segmentation State Persistence ─────────────────────
  if (action === 'RETURN_SEG_STATE') {
    // Save state coming back from the seg iframe
    segState = msg.state;
    return;
  }

  // ─── Handle “Close” from ANY modal ──────────────────────
  if (action === 'CLOSE_MODAL') {
    // Concat modal close
    doClose();
    return;
  }

  // ─── Multi‐file picker for Concat iframe ────────────────
  if (action === 'OPEN_FILES_DIALOG') {
    let paths = [];
    if (window.electronAPI?.openFilesDialog) {
      paths = await window.electronAPI.openFilesDialog({
        filters: msg.filters,
        properties: ['openFile','multiSelections']
      });
    } else {
      const input = document.createElement('input');
      input.type     = 'file';
      input.accept   = 'video/*';
      input.multiple = true;
      input.onchange = () => {
        paths = Array.from(input.files).map(f => f.path || URL.createObjectURL(f));
        sendVideoFiles(paths);
      };
      return input.click();
    }
    return sendVideoFiles(paths);
  }

  // ─── Single‐file picker for Concat iframe ───────────────
  if (action === 'OPEN_FILE_DIALOG') {
    let filePath = null;
    try {
      filePath = await window.electronAPI.openFileDialog({
        filters: msg.filters || [{ name: 'Videos', extensions: ['mp4','mov','mkv','avi'] }]
      });
    } catch (err) {
      console.error("[PARENT] openFileDialog error", err);
    }
    event.source.postMessage({ action: 'OPEN_FILE_DIALOG_RESULT', filePath }, '*');
    return;
  }

  // ─── Directory picker for Concat iframe ─────────────────
  if (action === 'OPEN_DIRECTORY_DIALOG') {
    let dir = '';
    if (window.electronAPI?.openDirectoryDialog) {
      try {
        dir = await window.electronAPI.openDirectoryDialog({
          properties: ['openDirectory','createDirectory']
        });
      } catch (err) {
        console.error("[PARENT] openDirectoryDialog error", err);
      }
    }
    event.source.postMessage({ action: 'OPEN_DIRECTORY_DIALOG_RESULT', dirPath: dir || '' }, '*');
    return;
  }

  // ─── Concat Finished ────────────────────────────────────
  if (action === 'CONCAT_COMPLETE') {
    // reopen modal if closed
    if (!modalVisible) {
      modal.style.display = 'flex';
      modalVisible = true;
      document.body.style.overflow = 'hidden';
    }
    Swal.fire({
      background: '#2f2f2f',
      color: '#ffffff',
      icon: 'success',
      title: 'Export Complete',
      text: `Saved to:\n${msg.output}`,
      confirmButtonText: 'OK'
    });
    return;
  }

  // ─── WebSocket Disconnect/Reconnect ─────────────────────
  if (action === 'WS_DISCONNECTED') {
    Swal.fire({
      background: '#2f2f2f',
      color: '#ffffff',
      icon: 'warning',
      title: 'Connection Lost',
      text: msg.text || 'Reconnecting…',
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }
  if (action === 'WS_RECONNECTED') {
    Swal.fire({
      background: '#2f2f2f',
      color: '#ffffff',
      icon: 'success',
      title: 'Reconnected',
      text: msg.text || 'WebSocket is back online.',
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }

  // ─── Helper: send selected files back to Concat iframe ───
  async function sendVideoFiles(paths) {
    const files = await Promise.all(paths.map(async p => {
      let size = 0;
      if (window.electronAPI?.getFileStats) {
        try { size = (await window.electronAPI.getFileStats(p)).size; }
        catch {}
      }
      return { path: p, size };
    }));
    event.source.postMessage({ type: 'VIDEO_FILES', files }, event.origin);
  }

  // ─── Unhandled messages ──────────────────────────────────
  console.log("[PARENT] Unrecognized action:", action);
});

  // ─── Initialize Bootstrap tooltips ───────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
         .forEach(el => new bootstrap.Tooltip(el));
  });

  // ─── Your existing returnToVideoView ────────────────────
  function returnToVideoView() {
    document.getElementById("videoWrapper").innerHTML = `
      <h5 id="videoTitle"></h5>
      <div class="video-container">
        <video id="videoPlayer" preload="auto"></video>
        <canvas id="drawCanvas"></canvas>
        <div class="bottom-controls">
          <!-- etc. -->
        </div>
      </div>
    `;
    document.getElementById("returnToVideoBtn").style.display = 'none';
    showToast("Back to Video Viewer");
  }
</script>


</body>
</html>
